name: BTC Ã— Qimen Daily Report (Zero-Dependency)

on:
  schedule:
    # 08:10 KST = 23:10 UTC (ì „ë‚ )
    - cron: '10 23 * * *'
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch 1h klines (UTC) from Binance
        run: |
          mkdir -p work Reports
          # ìµœê·¼ 70ì¼ì¹˜ ì •ë„ë¥¼ 1ì‹œê°„ë´‰ìœ¼ë¡œ ìˆ˜ì§‘ (3íšŒ ë¶„í• )
          NOW_UTC=$(date -u +%s)
          START=$((NOW_UTC - 70*24*3600))
          MID=$((START + 30*24*3600))
          curl -s "https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1h&startTime=$((START*1000))" > work/part1.json
          curl -s "https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1h&startTime=$((MID*1000))"   > work/part2.json
          # ë§ˆì§€ë§‰ êµ¬ê°„(ëì‹œê°„ ì§€ì • X)
          curl -s "https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1h"                           > work/part3.json

      - name: Build report (Python stdlib only)
        env:
          TZ: Asia/Seoul
        run: |
          python - <<'PY'
          import json, math, os
          from datetime import datetime, timedelta, timezone
          KST = timezone(timedelta(hours=9))

          def load_parts():
              rows=[]
              for p in ["work/part1.json","work/part2.json","work/part3.json"]:
                  if not os.path.exists(p): continue
                  try:
                      arr = json.load(open(p))
                      for k in arr:
                          # kline format: [openTime, open, high, low, close, volume, closeTime, ...]
                          ts = int(k[0])//1000  # seconds UTC
                          close = float(k[4])
                          rows.append((ts, close))
                  except Exception:
                      pass
              rows.sort()
              return rows

          rows = load_parts()
          if not rows:
              today = datetime.now(tz=KST).date()
              open(f"Reports/report_{today}.txt","w",encoding="utf-8").write(
                  f"[Fallback] {today} (KST)\në°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨. ë‚´ì¼ ë‹¤ì‹œ ì‹œë„.\n"
              )
              raise SystemExit(0)

          # UTC->KST, 1h -> ì¼ë´‰ ì¢…ê°€(24:00 KST) ì¬ì§‘ê³„
          from collections import OrderedDict
          by_day = OrderedDict()
          for ts, close in rows:
              dt_kst = datetime.fromtimestamp(ts, tz=timezone.utc).astimezone(KST)
              day = dt_kst.date()
              key = day
              by_day[key] = close  # ê°™ì€ ë‚ ì´ë©´ ë§ˆì§€ë§‰(=í•˜ë£¨ ë ê°€ê¹Œìš´ ì‹œê°)ì´ ì¢…ê°€ì²˜ëŸ¼ ë‚¨ìŒ

          days = sorted(by_day.keys())
          closes = [by_day[d] for d in days]

          # ìˆ˜ìµë¥ /RSI(14)
          rets = [None]
          for i in range(1,len(closes)):
              rets.append((closes[i]/closes[i-1]-1.0))
          def rsi14(vals):
              if len(vals)<15: return [None]*len(vals)
              out=[None]*len(vals)
              for i in range(len(vals)):
                  if i<14: continue
                  gains = [max(vals[j]-vals[j-1],0.0) for j in range(i-13, i+1)]
                  losses= [max(vals[j-1]-vals[j],0.0) for j in range(i-13, i+1)]
                  avg_g = sum(gains)/14.0
                  avg_l = sum(losses)/14.0 or 1e-12
                  rs = avg_g/avg_l
                  out[i] = 100 - (100/(1+rs))
              return out
          rsi = rsi14(closes)

          # ì˜¤ëŠ˜/ì–´ì œ
          today = datetime.now(tz=KST).date()
          yday  = today - timedelta(days=1)

          # rsi_sig
          def rsi_sig_val(x):
              if x is None: return 0
              return 1 if x>55 else (-1 if x<45 else 0)

          # ê°„ì§€/ì˜¤í–‰/ë¬¸ (ì•µì»¤: 2025-10-20 = å£¬æˆŒ)
          HEAVENLY="ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸"; EARTHLY="å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥"
          ELEM_OF={"ç”²":"wood","ä¹™":"wood","ä¸™":"fire","ä¸":"fire","æˆŠ":"earth","å·±":"earth","åºš":"metal","è¾›":"metal","å£¬":"water","ç™¸":"water"}
          GATES=list("é–‹ä¼‘ç”Ÿå‚·æœæ™¯æ­»é©š")
          def ganji_for(d):
              from datetime import date as D
              anchor_h, anchor_e = "å£¬","æˆŒ"
              anchor_date = datetime(2025,10,20,tzinfo=KST).date()
              delta=(d-anchor_date).days
              h = HEAVENLY[(HEAVENLY.index(anchor_h)+delta)%10]
              e = EARTHLY[(EARTHLY.index(anchor_e)+delta)%12]
              return h+e
          def elements(ganji):
              stem, branch = ganji[0], ganji[1]
              base={"wood":.18,"fire":.18,"earth":.18,"metal":.18,"water":.18}
              dom=ELEM_OF.get(stem)
              if dom: base[dom]+=.12
              if branch in "å­äº¥": base["water"]+=.04
              if branch in "å¯…å¯": base["wood"] +=.04
              if branch in "å·³åˆ": base["fire"] +=.04
              if branch in "ç”³é…‰": base["metal"]+=.04
              if branch in "è¾°æˆŒä¸‘æœª": base["earth"]+=.04
              s=sum(base.values())
              for k in base: base[k]=round(base[k]/s,4)
              return base
          def gate_of(ganji):
              return GATES[(ord(ganji[0])+ord(ganji[1]))%len(GATES)]
          GATE_BIAS={"é–‹": .05,"ä¼‘": .02,"ç”Ÿ": .03,"å‚·":-.03,"æœ":-.02,"æ™¯": .01,"æ­»":-.05,"é©š":-.04}

          # ìµœê·¼ 30ì¼ ì˜¨ë¼ì¸ ë¡œì§€ìŠ¤í‹±(ê°„ë‹¨)
          W={k:0.0 for k in ["wood","fire","earth","metal","water"]}; BIAS=0.0; LR=0.06
          EMA=0.5; ALPHA=0.2
          def prob(logit): return 1/(1+math.exp(-logit))

          # í•™ìŠµìš© ë°ì´í„° êµ¬ì„±
          day_to_idx={d:i for i,d in enumerate(days)}
          def row_for(d):
              gan = ganji_for(d); ele=elements(gan); gate=gate_of(gan)
              idx = day_to_idx.get(d)
              rsiv = rsi[idx] if idx is not None else None
              sig = rsi_sig_val(rsiv)
              ret = rets[idx] if idx is not None else None
              return {"date":d,"ele":ele,"gate":gate,"rsi_sig":sig,"ret":ret}

          train_days=[d for d in days if d<today][-30:]
          for d in train_days:
              r=row_for(d)
              if r["ret"] is None: continue
              s = BIAS + sum(W[k]*r["ele"][k] for k in W) + GATE_BIAS.get(r["gate"],0.0) + 0.1*r["rsi_sig"]
              p = prob(s); y = 1.0 if r["ret"]>0 else 0.0
              grad = (p-y)
              BIAS -= LR*grad*0.2
              for k in W: W[k] -= LR*grad*r["ele"][k]
              hit = (p>=0.5)==(y==1.0)
              EMA = (1-ALPHA)*EMA + ALPHA*(1.0 if hit else 0.0)

          # ì˜¤ëŠ˜ ì˜ˆì¸¡
          rt = row_for(today)
          s_today = BIAS + sum(W[k]*rt["ele"][k] for k in W) + GATE_BIAS.get(rt["gate"],0.0) + 0.1*rt["rsi_sig"]
          p_today = prob(s_today)
          lbl_pred = "ìƒìŠ¹" if p_today>=0.5 else "í•˜ë½"

          # ì „ì¼ ì‹¤ì œ
          actual = None
          if yday in day_to_idx and rets[day_to_idx[yday]] is not None:
              actual = "ìƒìŠ¹" if rets[day_to_idx[yday]]>0 else "í•˜ë½"

          # ë¦¬í¬íŠ¸ ìƒì„±
          wood,fire,earth,metal,water = [rt["ele"][k] for k in ["wood","fire","earth","metal","water"]]
          rsi_last = None
          if days and days[-1] in day_to_idx:
              rsi_last = rsi[day_to_idx[days[-1]]]
          rsisig = rt["rsi_sig"]

          lines=[]
          lines.append(f"[BTC Ã— ê¸°ë¬¸â€§ì˜¤í–‰ ì¼ì¼ ë¦¬í¬íŠ¸] {today} (KST)")
          lines.append(f"ğŸ”¹ ì˜ˆì¸¡ ëŒ€ìƒì¼: {today}")
          lines.append(f"ğŸ”¹ ê²€ì¦ ëŒ€ìƒì¼: {yday}")
          lines.append(f"ğŸŒ¿ ì˜¤í–‰ì§€ìˆ˜: æœ¨{wood:.2f} ç«{fire:.2f} åœŸ{earth:.2f} é‡‘{metal:.2f} æ°´{water:.2f} Â· é–€:{rt['gate']}")
          lines.append(f"ğŸ“ˆ RSI14: {('N/A' if rsi_last is None else f'{rsi_last:.1f}')} Â· ë³´ì¡°ì‹œê·¸ë„: {rsisig}")
          lines.append(f"ğŸ¯ ì˜¤ëŠ˜ ì˜ˆì¸¡: {lbl_pred} (í™•ë¥  {p_today*100:.1f}%)")
          if actual is None:
              lines.append("ğŸ§ª ì „ì¼ ê²°ê³¼: ë°ì´í„° ë¶€ì¡±")
          else:
              hit = "ì ì¤‘ âœ…" if ((p_today>=0.5 and actual=='ìƒìŠ¹') or (p_today<0.5 and actual=='í•˜ë½')) else "ë¹—ë‚˜ê° âŒ"
              lines.append(f"ğŸ§ª ì „ì¼ ê²°ê³¼: {actual} â†’ {hit}")
          ws = " ".join([f"{k}{W[k]:+0.02f}" for k in ["wood","fire","earth","metal","water"]])
          lines.append(f"ğŸ“Š EMA ì ì¤‘ë¥ (ìµœê·¼ 30ì¼): {EMA*100:.1f}%")
          lines.append(f"âš™ï¸ ê°€ì¤‘ì¹˜: {ws} Â· bias:{BIAS:+0.02f} Â· lr:{LR}")
          lines.append("ğŸ• ê·œì¹™: KST 00:00â€“24:00, UTCâ†’KST ë³´ì •, æœˆ=ä¸­æ°£, å¹´=ç«‹æ˜¥")

          today_str=str(today)
          os.makedirs("Reports", exist_ok=True)
          open(f"Reports/report_{today_str}.txt","w",encoding="utf-8").write("\n".join(lines))
          print("Report written: Reports/report_%s.txt" % today_str)
          PY

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: daily-report
          path: Reports/
